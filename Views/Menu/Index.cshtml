@model IEnumerable<RestaurantWebsite.Models.Dish>
@{
    ViewData["Title"] = "Menu";
}

<div class="menu-page">
    <div class="container">
        <h1 class="text-center mb-4">Our Menu</h1>

        <!-- Filter form -->
        <div class="card shadow-sm p-3 mb-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="search" class="form-label">Search</label>
                    <input type="text" id="search" class="form-control" placeholder="Search dishes..." onkeyup="filterDishes()" />
                </div>
                <div class="col-md-2">
                    <label for="minPrice" class="form-label">Min Price</label>
                    <input type="number" id="minPrice" class="form-control" step="0.01" onchange="filterDishes()" />
                </div>
                <div class="col-md-2">
                    <label for="maxPrice" class="form-label">Max Price</label>
                    <input type="number" id="maxPrice" class="form-control" step="0.01" onchange="filterDishes()" />
                </div>
                <div class="col-md-2 align-self-end">
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle w-100" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Filter
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                            <li><a class="dropdown-item" href="#" onclick="setPopularFilter('all'); return false;">All Dishes</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setPopularFilter('popular'); return false;">Popular Only</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setPopularFilter('regular'); return false;">Regular Only</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="noResults" class="alert alert-info text-center" style="display: none;">
            No dishes found matching your filters.
        </div>

        <div class="row g-4" id="dishesContainer">
            @foreach (var dish in Model)
            {
                <div class="col-md-4 dish-item"
                     data-name="@dish.Name.ToLower()"
                     data-description="@dish.Description.ToLower()"
                     data-price="@dish.Price"
                     data-popular="@dish.IsPopular.ToString().ToLower()">
                    <div class="card h-100 shadow-sm">
                        @{
                            var imageUrl = string.IsNullOrEmpty(dish.ImageUrl)
                            ? Url.Content("~/images/menu.png")
                            : dish.ImageUrl;
                        }
                        <img src="@imageUrl" alt="@dish.Name" class="card-img-top" />
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@dish.Name</h5>
                            <p class="card-text">@dish.Description</p>
                            <div class="mt-auto">
                                <span class="fw-bold">@dish.Price.ToString("F2") $USD</span>
                                @if (dish.IsPopular)
                                {
                                    <span class="badge bg-warning text-dark ms-2">Popular</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPopularFilter = 'all';

        function setPopularFilter(filter) {
            currentPopularFilter = filter;

            // Update button text
            const btn = document.getElementById('filterDropdown');
            if (filter === 'popular') {
                btn.textContent = 'Popular Only';
            } else if (filter === 'regular') {
                btn.textContent = 'Regular Only';
            } else {
                btn.textContent = 'Filter';
            }

            filterDishes();
        }

        function filterDishes() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;

            const dishItems = document.querySelectorAll('.dish-item');
            let visibleCount = 0;

            dishItems.forEach(item => {
                const name = item.getAttribute('data-name');
                const description = item.getAttribute('data-description');
                const price = parseFloat(item.getAttribute('data-price'));
                const isPopular = item.getAttribute('data-popular') === 'true';

                // Check search
                const matchesSearch = searchTerm === '' ||
                                     name.includes(searchTerm) ||
                                     description.includes(searchTerm);

                // Check price range
                const matchesPrice = price >= minPrice && price <= maxPrice;

                // Check popularity filter
                let matchesPopular = true;
                if (currentPopularFilter === 'popular') {
                    matchesPopular = isPopular;
                } else if (currentPopularFilter === 'regular') {
                    matchesPopular = !isPopular;
                }

                // Show or hide
                if (matchesSearch && matchesPrice && matchesPopular) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Show/hide "no results" message
            const noResults = document.getElementById('noResults');
            if (visibleCount === 0) {
                noResults.style.display = 'block';
            } else {
                noResults.style.display = 'none';
            }
        }
    </script>
}